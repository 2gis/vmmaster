---
- name: ensure nginx official repository is present
  apt_repository: repo=ppa:nginx/stable

- name: install nginx
  apt: >
    name={{ nginx_name }}
    state=installed
    force=yes

- name: write nginx.conf
  template: >
    src=nginx.conf.j2
    dest=/etc/nginx/nginx.conf
  notify: reload nginx

- name: delete default vhost
  file: >
    path=/etc/nginx/sites-enabled/{{ item }}
    state=absent
  with_items:
    - default
    - default.conf
  when: nginx_delete_default_vhost
  notify: reload nginx

- name: nginx status vhost
  copy:
    dest: /etc/nginx/sites-enabled/nginx_status.conf
    src: nginx_status.conf
    force: no
  when: nginx_status_vhost
  notify: reload nginx

- name: nginx deny ip default host
  copy:
    dest: /etc/nginx/sites-enabled/deny_by_ip.conf
    src: deny_by_ip.conf
    force: no
  when: nginx_deny_by_ip
  notify: reload nginx