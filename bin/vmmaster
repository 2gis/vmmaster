#!/usr/bin/env python

"""vmmaster virtual machines.

Usage:
  vmmaster
  vmmaster init
  vmmaster --daemon
  vmmaster (-h | --help)
  vmmaster (-v | --version)

Options:
  -h --help     Show this screen.
  -v --version  Show version.
"""

import os

from twisted.internet import reactor
from docopt import docopt

from vmmaster.core.config import setup_config, config
from vmmaster.core.utils.init import init, home_dir
from vmmaster.core import db

try:
    setup_config('%s/config.py' % home_dir())
    db.database = db.Database(config.DATABASE)
except AttributeError:
    config = None
    db.database = None

from vmmaster.core.logger import setup_logging
from vmmaster.server import VMMasterServer
from vmmaster.core.daemon import Daemon
from vmmaster.core.utils.utils import change_user_vmmaster


def main():
    change_user_vmmaster()
    setup_logging(config.LOG_DIR)

    VMMasterServer(reactor, config.PORT).run()


class VMMasterDaemon(Daemon):
    def run(self):
        main()


if __name__ == '__main__':
    arguments = docopt(__doc__, version='0.1')
    if arguments['init'] is True:
        init()

    if arguments['--daemon'] is True:
        daemon = VMMasterDaemon(os.path.join(home_dir(), 'vmmaster.pid'))
        daemon.start()
    else:
        main()