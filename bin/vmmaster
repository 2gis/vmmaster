#!/usr/bin/env python

"""vmmaster virtual machines.

Usage:
  vmmaster
  vmmaster init
  vmmaster --background
  vmmaster (-h | --help)
  vmmaster (-v | --version)

Options:
  -h --help     Show this screen.
  -v --version  Show version.
"""

from docopt import docopt

from vmmaster.core.config import setup_config, config
from vmmaster.core.logger import setup_logging, log
from vmmaster.core.server.server import VMMasterServer
from vmmaster.core.daemon import Daemon
from vmmaster.console.init import init, home_dir
from vmmaster.utils.utils import change_user_vmmaster


def main():
    change_user_vmmaster()
    setup_config('%s/config.py' % home_dir())
    setup_logging(config.LOG_DIR)

    server_address = ('', config.PORT)
    server = VMMasterServer(server_address)

    log.info('Starting server...')
    try:
        server.run()
    except KeyboardInterrupt:
        pass
    finally:
        log.info("shutting down...")
        del server


class VMMasterDaemon(Daemon):
    def run(self):
        main()


if __name__ == '__main__':
    arguments = docopt(__doc__, version='0.1')
    if arguments['init'] is True:
        init()

    if arguments['--background'] is True:
        daemon = VMMasterDaemon('/var/run/vmmaster.pid')
        daemon.start()
    else:
        main()